# LMask: Learn to Solve Constrained Routing Problems with Lazy Masking 
<details>
    <summary><strong>Overview</strong></summary>
<p align="center"><img src="./assets/LMask.png" width=95%></p>
</details>

## Installation
We  recommend installing the environment from the file by running the following commands
```bash
conda create -n lmask python=3.10
conda activate lmask
pip install -r requirements.txt
```
<!-- - Main Python packages:
  * PyTorch = 2.5.1
  * RL4CO = 0.5.2
  * TensorDict = 0.6.2
  * pytorch-lightning = 2.5.0 
  * PyVRP = 0.11.0
  * Numpy = 2.2.6
  * Pandas
  * tqdm -->
  

## Quickstart
### Generate Datasets
The validation and test datasets can be generated by running the following command:
```bash
python generate_datasets.py
```
### Test
* Test a specific random dataset
```bash
python driver/test.py --problem tsptw --problem_size 50 --hardness hard
```
You can also provide additional parameters like `max_backtrack_steps` and `lookahead_step` (see the script for more details).
* Test all datasets
```bash
python driver/test_all.py
```

* Test Dumas benchmark instances for TSPTW
```bash
python driver/test_dumas.py
```

### Training
```bash
python run.py experiment=main/tsptw/tsptw50-medium
```
You may change the experiment `experiment=main/tsptw/tsptw50-medium` by using the `experiment=YOUR_EXP`, with the path under [`configs/experiment`](configs/experiment) directory.

**Note**: After training, to use the checkpoints in test.py, you should first run the script `sripts/transform_checkpoints.py` to convert ckpt files to pth files.

## Results
### Backtracking vs. Lookahead
The following figure shows results across different lookahead steps. With two-step lookahead (TSL), LMask attains a zero solution infeasibility rate within 20s. Even with the less accurate single-step lookahead (SSL), LMask drives the infeasibility rate down to the second lowest level by allocating a larger backtracking budget. However, PIP and PIP-D exhibit unacceptably high infeasibility rates under SSL. Increasing the lookahead step from 2 to 3 induces an order of magnitude rise in inference time while yielding only marginal gains and the outcomes remain inferior to LMask under SSL with $R=700$. These results demonstrate that backtracking combined with a lightweight lookahead initialization is more efficient than methods that rely exclusively on deeper lookaheads. 
<p align="center">
  <img src="./assets/backtrack_lookahead.png">
</p>

### Effect of Backtracking Budget
The following figure demonstrates how the backtracking budget $R$ influences the performance of LMask under TSL. The results show that inference time exhibits a nearly linear growth with respect to $R$, with an increase of approximately 2 seconds per 100 additional backtracking budget, demonstrating manageable computational overhead. In contrast, infeasibility rates decrease sharply at small values of $R$, indicating substantial early-stage gains in feasibility. Notably, instance infeasibility effectively vanishes at $R=100$, requiring only 17 seconds of inference time. These results highlight that larger backtracking budgets substantially improve solution feasibility with modest increases in runtime.
<p align="center">
  <img src="./assets/backtracking_budget_TSL.png">
</p>

### Ablation Study on Refinement Intensity Embedding
<p align="center">
  <img src="./assets/RIE_ablation.png">
</p>

### Effect of the Entropy Term
In the following figure, we report the results on easy TSPTW-100  for models trained with different entropy coefficients $\lambda$. The optimality gap exhibits a non-monotonic pattern. It decreases as $\lambda$ increases from 0 to 0.01, achieving the best performance at $\lambda=0.01$, but then rises significantly at $\lambda=0.05$. 
This reflects the intrinsic trade-off between exploration and concentration in the probabilistic model, and suggests that choosing an appropriate entropy coefficient can improve solution optimality. This observation also aligns with our theoretical analysis in our paper.
<p align="center">
  <img src="./assets/entropy.png">
</p>

## Citation
```bash
@article{li2025lmask,
  title={LMask: Learn to Solve Constrained Routing Problems with Lazy Masking},
  author={Li, Tianyou and Zou, Haijun and Wu, Jiayuan and Wen, Zaiwen},
  journal={arXiv preprint arXiv:2505.17938},
  year={2025}
}
```